<!DOCTYPE html>
<html>

<head>
    <title>OECD Municipal Atlas</title>
    <base href="/">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.1.0/dist/esri-leaflet-vector.js"></script>
    
    <!-- load VectorGrid extension -->
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script> 

    <!-- load Geotiff extension -->
    <!-- <script src="https://unpkg.com/georaster"></script> -->
    <script src="https://unpkg.com/chroma-js"></script>
    <link rel="stylesheet" href="{{ './css/styles.css' | relative_url }}">
    <link rel="stylesheet" href="fontawesome/css/brands.css">
    <link rel="stylesheet" href="fontawesome/css/fontawesome.css">
    <link rel="stylesheet" href="fontawesome/css/regular.css">
    <script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://www.unpkg.com/papaparse@5.4.1/papaparse.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>


</head>

<body>
    <div id="app" data-v-app="">

        <div class="relative flex min-h-screen flex-col bg-white">
            <nav class="top-0 border-b border-gray-200 bg-gray-100 sm:sticky z-20 sm:z-20 sm:shadow-lg print:!hidden">
                <div class="mx-auto max-w-1xl px-4 sm:px-6 lg:px-8">
                    <div class="flex h-16 items-center justify-between">
                        <div class="flex items-center">
                            <a class="flex shrink-0 items-center mr-4 ml-0">
                                <img src="{{ './img/OECD_logo_new.svg.png' | relative_url }}" class="h-8 sm:h-10 w-auto" />
                            </a>
                            <div class="font-bold text-xl sm:text-2xl text-gray-700 hidden sm:flex" style="padding: 20px;">
                                Municipal Atlas
                            </div>
                        </div>
                        
                        <div class="sm:-my-px sm:flex sm:space-x-4 justify-between items-center">
                            <a href="/"
                            class="inline-flex items-center px-1 font-bold text-gray-500 hover:text-gray-700"
                            aria-current="page">Maps</a>
                            <a href="{{ './profile.html' | relative_url }}"
                            class="!text-gray-900 router-link-exact-active inline-flex items-center px-1 font-bold text-gray-500 hover:text-gray-700">Profile</a>
                            <a href="{{ './methodology.html' | relative_url }}"
                            class="inline-flex items-center px-1 font-bold text-gray-500 hover:text-gray-700">Methodology</a>
                        </div>
                        
                    
                    </div>
                </div>
            </nav>

            <div class="grow">
                <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex gap-4 py-16">
                    <div class="flex flex-col gap-4 break-words print:!w-full sm:w">
                        <div class="flex flex-col gap-4">
                            <h2 class="text-3xl font-extrabold sm:text-4xl">
                                Municipal profile
                            </h2>
                            <div class="text-lg text-gray-500"> 
                                This page allows users to search for a municipality and to display a summary of key indicators. 
                                It also provides the capability to compare these indicators with other geographical levels as well as the OECD average.
                            </div>
                            <div class="flex flex-row items-center justify-start">
                                <div class="rounded-md shadow-sm ">
                                    <select id='searchTl1' style="width: 100%; max-width: 400px; padding: 10px;">
                                    </select>
                                    <!-- <select id='searchTl1' style="width: 100%; max-width: 400px; padding: 10px;">
                                    </select> -->
                                </div>
                                <div style="width: 100%; max-width: 400px; padding: 10px;">
                                    <select id='searchSau' style="width: 100%; max-width: 400px; padding: 10px; display: none;">
                                    </select>
                                </div>
                                                                
                            </div>
                        </div>
                        <hr />

                        <div class="flex gap-4 justify-between print:!w-full sm:w min-h-96">
                            
                            <div id="map" class="rounded-md border border-gray-600" style="height: 400px; width: 100%; float: right; position: relative; z-index: 10">
                                <div id='profileSauTitle' style="z-index: 10000" ></div>
                            </div>
                        </div>
                        
                        
                        <div id='profileSauHighlights' class="flex flex-col gap-8 break-words print:!w-full sm:w">                          
                        </div>

                        <div id='profileSau' class="flex flex-col gap-8 break-words print:!w-full sm:w">                          
                        </div>


                        <div id='radar-chart-container' class="flex flex-col items-center gap-8 text-center" style="width: 80%; margin:auto">
                            <canvas id="radar-chart" class="items-center text-center" style="width: 80%;"></canvas>
                        </div>
                    </div>
                </div>  
            </div>
        </div> 
    </div>
    
<script  type="text/javascript" src="{{ './js/idcard.js' | relative_url }}"></script>
<script  type="text/javascript" src="{{ './js/searchbar.js' | relative_url }}"></script>
<script  type="text/javascript" src="{{ './js/chart.js' | relative_url }}"></script>

<script>

function buildBaseMap() {
    var map = L.map('map', {
        center: [48.8566, 2.3522],
        minZoom: 3,
        maxZoom: 12,
        zoomControl: false,
        zoom: 7,        
    });

    var mapBaseLayer = L.esri.Vector.vectorBasemapLayer("8d891c38ed57477aa1db1693c144bab4", {
        apikey: "AAPK6733906110644097bc8da019ac9689e2vgrUl21eT8xUm1vNGb7Ovg7qfyhqoi0Ka0yYuNo7J1ER0XeYWtyHpyy7tr5nNtXk", 
    });
    mapBaseLayer.addTo(map);

    var mapBaseLabelsLayer = L.esri.Vector.vectorBasemapLayer("arcgis/light-gray/labels", {
    apikey: "AAPK6733906110644097bc8da019ac9689e2vgrUl21eT8xUm1vNGb7Ovg7qfyhqoi0Ka0yYuNo7J1ER0XeYWtyHpyy7tr5nNtXk", 
    zindex: 10,
    });
    mapBaseLabelsLayer.addTo(map);

    var mapBaseTL1PlainUrl = "https://municipalatlas.blob.core.windows.net/tiles/tl1_plain_tiles/{z}/{x}/{y}.pbf";
    var mapBaseTL1PlainStyling = {
            "tl1_plain_boundaries": function (properties, zoom) {
                return {
                    fill: false, // No fill
                    weight: 1,
                    color: "#626262", // Black color
                    opacity: 1.0,
                };
            }
    };
    var mapBaseTL1PlainTileOptions = {
        rendererFactory: L.canvas.tile,
        interactive: false,
        maxNativeZoom: 12,
        minZoom: 0,
        vectorTileLayerStyles: mapBaseTL1PlainStyling,
        attribution: "Source of administrative boundaries: National Statistical Offices and FAO Global Administrative Unit Layers (GAUL). This map is for illustrative purposes and is without prejudice to the status of or sovereignty over any territory covered by this map."
    };
    try {
        var mapBaseTL1PlainLayer = new L.VectorGrid.Protobuf(mapBaseTL1PlainUrl, mapBaseTL1PlainTileOptions);
        mapBaseTL1PlainLayer.setZIndex(12).addTo(map);
    } catch (error) {
        // Handle the error here (or ignore it)
        console.error("Error loading PBF file:", error);
    }

    var mapBaseTL1DottedUrl = "https://municipalatlas.blob.core.windows.net/tiles/tl1_dotted_tiles/{z}/{x}/{y}.pbf";
    var mapBaseTL1DottedStyling = {
            "tl1_dotted_boundaries": function (properties, zoom) {
                return {
                    fill: false, // No fill
                    weight: 1,
                    color: "#626262", // Black color
                    opacity: 1.0,
                    dashArray: "4, 4",
                };
            }
    };
    var mapBaseTL1DottedTileOptions = {
        rendererFactory: L.canvas.tile,
        interactive: false,
        maxNativeZoom: 12,
        minZoom: 0,
        vectorTileLayerStyles: mapBaseTL1DottedStyling
    };
    try {
        var mapBaseTL1DottedLayer = new L.VectorGrid.Protobuf(mapBaseTL1DottedUrl, mapBaseTL1DottedTileOptions);
        mapBaseTL1DottedLayer.setZIndex(12).addTo(map);
    } catch (error) {
        console.error("Error loading PBF file:", error);
    }

    return map;
}

var currentButton;
var currentTopicContent;

let radarChart;
let mapProfile;

$.getJSON("https://municipalatlas.blob.core.windows.net/data/data/geo_names/tl1_names_map.json", function(_json) {
    df_tl1 = $.map(_json, function (obj) {
        obj.text = obj.tl1_name_en; // replace name with the property used for the text
        obj.id = obj.iso3; // replace pk with your identifier
        return obj;
        });
    df_tl1.unshift({ id: "", text: "" });
    //df_region_names; // this will show the info it in firebug console
    autcomplete_search(df_tl1, 1, 0, 'searchTl1', 'Select a country');

    $('#searchTl1').on('change', function (e) {
        var selectedValue = e.target.value;
        // console.log(selectedValue);
        if (selectedValue != null) {
            searchSauElem = document.getElementById("searchSau");
            searchSauElem.style.display = "block";
            $.getJSON(`https://municipalatlas.blob.core.windows.net/data/data/geo_names/sau_names/${selectedValue}.json`, function(_json) {
                df_sau = $.map(_json, function (obj) {
                    obj.text = obj.tl2_name_en; // replace name with the property used for the text
                    obj.id = obj.tl2_id; // replace pk with your identifier
                    return obj;
                    });
                df_sau.unshift({ id: "", text: "" });
                //df_region_names; // this will show the info it in firebug console
                autcomplete_search(df_sau, 1, 3, 'searchSau', 'Select a municipality');
        
            
            });
            }

        });
    
    $('#searchSau').on('change', function (e) {
        var selectedSau = e.target.value;
        var selectedTl1 = selectedSau.substring(0, 3);
        // console.log(selectedSau);
        // console.log(selectedTl1);
        sauProfileElem = document.getElementById("profileSau");
        // sauNameElem = document.getElementById("sauName");

        var jsonFilePath = `https://municipalatlas.blob.core.windows.net/data/data/geo_data/${selectedTl1}/${selectedSau}.json`;
        fetch(jsonFilePath) 
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // Get the raw text
            })
            .then(data => {
                if (mapProfile == undefined) {
                    mapProfile = buildBaseMap();
                    $('.leaflet-control-attribution').hide()
                }
                var geojsonLayer = L.geoJSON(data).addTo(mapProfile);
                mapProfile.fitBounds(geojsonLayer.getBounds());
                sauProfileContentHtml = buildSauProfile(data.features[0].properties);
                sauProfileTitleHtml = buildSauTitle(data.features[0].properties);
                sauProfileHighlightsHtml = buildSauHighlights(data.features[0].properties);

                sauProfileElem = document.getElementById("profileSau");
                sauProfileTitleElem = document.getElementById("profileSauTitle");
                sauProfileHighlightsElem = document.getElementById("profileSauHighlights");

                sauProfileTitleElem.innerHTML = sauProfileTitleHtml;
                sauProfileHighlightsElem.innerHTML = sauProfileHighlightsHtml;
                sauProfileElem.innerHTML = sauProfileContentHtml.current;
                currentButton = document.getElementById(`button-demography`);
                currentTopicContent = document.getElementById(`topic-content`);
                console.log(currentTopicContent.innerHTML);

                buildSauTabProfile(sauProfileContentHtml.demography, "demography")
                buildSauTabProfile(sauProfileContentHtml.environment, "environment")
                buildSauTabProfile(sauProfileContentHtml.climate, "climate")
                buildSauTabProfile(sauProfileContentHtml.economy, "economy")
                buildSauTabProfile(sauProfileContentHtml.ghsl, "ghsl")
                buildSauTabProfile(sauProfileContentHtml.services, "services")

                var sauname = data.features[0].properties.launame;
                var fuaname = data.features[0].properties.fuaname_en;
                var cityname = data.features[0].properties.cityname_en;
                var tl2_name_en = data.features[0].properties.tl2_name_en;
                var tl3_name_en = data.features[0].properties.tl3_name_en;

                radarElem = buildRadarChartData(data.features[0].properties);
                if (radarChart) {
                    radarChart.destroy();
                }
                radarChart = createRadarChart(radarElem);
            })
    });
    
});

function updateContent() {
    // Get the query parameter from the URL
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    if (urlParams.size != 0) {
        var selectedSau = urlParams.get('code');
        var selectedTl1 = selectedSau.substring(0, 3);

        jsonFilePath = `https://municipalatlas.blob.core.windows.net/data/data/geo_data/${selectedTl1}/${selectedSau}.json`
        // console.log(jsonFilePath)
        fetch(jsonFilePath) 
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json(); // Get the raw text
                    })
                    .then(data => {
                        if (mapProfile == undefined) {
                            mapProfile = buildBaseMap();
                            $('.leaflet-control-attribution').hide()
                        }
                        var geojsonLayer = L.geoJSON(data).addTo(mapProfile);
                        mapProfile.fitBounds(geojsonLayer.getBounds());
                        sauProfileContentHtml = buildSauProfile(data.features[0].properties);
                        sauProfileTitleHtml = buildSauTitle(data.features[0].properties);
                        sauProfileHighlightsHtml = buildSauHighlights(data.features[0].properties);

                        sauProfileElem = document.getElementById("profileSau");
                        sauProfileTitleElem = document.getElementById("profileSauTitle");
                        sauProfileHighlightsElem = document.getElementById("profileSauHighlights");

                        sauProfileTitleElem.innerHTML = sauProfileTitleHtml;
                        sauProfileHighlightsElem.innerHTML = sauProfileHighlightsHtml;
                        sauProfileElem.innerHTML = sauProfileContentHtml.current;
                        currentButton = document.getElementById(`button-demography`);
                        currentTopicContent = document.getElementById(`topic-content`);
                        console.log(currentTopicContent.innerHTML);

                        buildSauTabProfile(sauProfileContentHtml.demography, "demography")
                        buildSauTabProfile(sauProfileContentHtml.environment, "environment")
                        buildSauTabProfile(sauProfileContentHtml.climate, "climate")
                        buildSauTabProfile(sauProfileContentHtml.economy, "economy")
                        buildSauTabProfile(sauProfileContentHtml.ghsl, "ghsl")
                        buildSauTabProfile(sauProfileContentHtml.services, "services")

                        var sauname = data.features[0].properties.launame;
                        var fuaname = data.features[0].properties.fuaname_en;
                        var cityname = data.features[0].properties.cityname_en;
                        var tl2_name_en = data.features[0].properties.tl2_name_en;
                        var tl3_name_en = data.features[0].properties.tl3_name_en;

                        radarElem = buildRadarChartData(data.features[0].properties);
                        if (radarChart) {
                            radarChart.destroy();
                        }
                        radarChart = createRadarChart(radarElem);
                    })
    };
    
}

updateContent();



</script>

</body>
</html>